import{b as e,r as a,j as t,w as o,b4 as l,b5 as s,b7 as n,q as r,bc as i,v as d,ba as c,be as u,bf as m,F as h,bn as p,bA as f,cc as w,bo as b,bB as _,l as g,p as v,bd as S,br as y,b9 as x,cg as k,cd as D,ce as $,bh as L}from"./Akubela-element-plus-Vendor-47553b40.js";import{w as I,j,u as U,s as V,aL as R,g as A,a as P,a_ as E,b3 as z,n as C,m as O,k as B,M as T}from"./Akubela-login-home-part-Vendor-facddf88.js";import{_ as F}from"./index-d8b1faeb.js";import{_ as M}from"./DiaImgAvatar-6f430b9a.js";import{e as N,s as W}from"./config-178dd060.js";import{_ as q}from"./index-47428c0f.js";import{h as H,c as Y}from"./index-8f4b869f.js";import"./Akubela-devices-img-Vendor-0f46fa2c.js";import"./Akubela-scenes-security-other-img-Vendor-2a1534ad.js";const G={class:"scene-management-dialog"},J={class:"edit-form__div"},K={class:"scenes-modify__head"},Q=["src"],X={class:"scenes__head__img-font"},Z={__name:"dialog-add",emits:["update-list"],setup(g,{expose:v,emit:S}){let y=I(),x=j();x.getRoomList();const{t:k}=U(),D=e({loading:!1,recevieData:{},scenesList:[],diaShow:!1,title:"",imgShow:!1,featureArray:[],form:{},type:"add",table:[],secondObj:{},showUrl:!0,newRoomList:[]}),$=a();t((()=>x.roomList.filter((e=>!["all","public"].includes(e.area_id)))));const L={expandTrigger:"hover",value:"area_id",label:"name",multiple:!0,emitPath:!1},B=e({name:[{validator:(e,a,t)=>{var o;null==(o=D.scenesList)||o.forEach((e=>{e.name===a&&D.secondObj.name!==a&&t(new Error(k("The name already exists.")))})),(null==a?void 0:a.length)?t():t(new Error(k("Please enter a valid scene name.")))},trigger:"change"}],url:[{validator:(e,a,t)=>{if(!(null==a?void 0:a.length))return t(new Error(k("Please enter a valid IP address.")));const o=E(a)<=63,l=z(a);o&&l?t():t(new Error(k("Please enter a valid IP address.")))},trigger:"change"}],area:[{validator:(e,a,t)=>{(null==a?void 0:a.length)?t():t(new Error(k("Please select at least one area.")))},trigger:"change"}],scene_id_ext:[{validator:(e,a,t)=>{if(!(null==a?void 0:a.length))return t(new Error(k("Please enter a valid scene id.")));if(D.table.find((e=>e.scene_id_ext===D.form.scene_id_ext&&e.scene_id!==D.form.scene_id)))return t(new Error(k("The scene id is already exists.")));/^[0-9A-F]{5}$/.test(a)&&"00000"!==a?t():t(new Error(k("Please enter a valid scene id.")))},trigger:"change"}]}),T=e=>{e.length||C(k("Please select at least one area."),"error")},F=()=>{$.value.validate((async e=>{e&&(()=>{var e;D.recevieData[y.wId]=e=>{if(D.loading=!1,!e.success)return C(k("errorMessage"),"error");W(),"edit"===D.type?C(k("Edit Succeed!")):C(k("Add Succeed!"))};const a={type:"edit"===D.type?"ak_api/scene/set":"ak_api/scene/add",id:y.wId++,...D.form};a.icon?a.icon=+a.icon:a.icon=0,a.with_state=+D.form.with_state,null==(e=y.ws)||e.send(O(a))})()}))},W=()=>{D.diaShow=!1,D.form={},D.table=[],S("update-list")},q=()=>{var e;D.recevieData[y.wId]=e=>{var a,t;e.success?(null==(a=e.result)?void 0:a.mode)?D.showUrl=!1:"add"===D.type&&(D.form.url=null==(t=e.result)?void 0:t.url):C(k("errorMessage"),"error")};const a={type:"ak_api/config/get",config_type:"api_server_info",id:y.wId++};null==(e=y.ws)||e.send(O(a))},H=()=>{var e;D.recevieData[y.wId]=e=>{if(!e.success)return C(k("errorMessage"),"error");D.form.scene_id_ext=e.result};const a={type:"ak_api/id_ext/next",mode:1,id:y.wId++};null==(e=y.ws)||e.send(O(a))},Y=()=>{var e;D.recevieData[y.wId]=e=>{if(!e.success)return C(k("errorMessage"),"error");D.scenesList=e.result};const a={type:"ak_scenes/info",id:y.wId++};null==(e=y.ws)||e.send(O(a))};return o((()=>y.updataId),(e=>{V(D.recevieData,e,y)}),{immediate:!0}),v({init:(e,a)=>{var t,o,l,s,n;if(D.newRoomList=null==(s=null==(l=null==(o=null==(t=x.newRoomList)?void 0:t.map)?void 0:o.call(t,(e=>({...e,name:k(null==e?void 0:e.name)}))))?void 0:l.filter)?void 0:s.call(l,(e=>!("all"===e.area_id||"public"===e.area_id))),D.secondObj={},D.newRoomList.length?D.form.area=(e=>{const a=[];return function e(t){for(const o of t)a.push(o.area_id),o.children&&o.children.length>0&&e(o.children)}(e),a})(D.newRoomList):D.form.area=[],D.table=e,Y(),D.showUrl=!0,q(),a){D.secondObj=a,n=a.area,D.form.area=n,D.type="edit";for(let e in D.secondObj)D.form[e]="with_state"===e?!!D.secondObj[e]:D.secondObj[e];D.title=k("Edit Scene")}else H(),D.form.with_state=!1,D.type="add",D.title=k("Add Scene");D.diaShow=!0}}),(e,a)=>{const t=p,o=f,g=w,v=b,S=_;return l(),s(h,null,[n("div",G,[r(P,{show:D.diaShow,"onUpdate:show":a[6]||(a[6]=e=>D.diaShow=e),title:D.title,"back-show":!1,"button-ok-name":e.$t("Submit"),onButtonConfirm:F,onButtonCancel:W},{content:i((()=>[n("div",J,[r(S,{ref_key:"ruleFormRef",ref:$,model:D.form,rules:B,"label-width":"200px",class:"scene-add-edit-form","label-position":"top",size:d(N)},{default:i((()=>[n("div",K,[n("div",{class:"scenes-modify__head__img",onClick:a[0]||(a[0]=e=>D.imgShow=!0)},[n("img",{alt:"smart home,home automation,homekit,smart security,smart home systems,google home",src:d(R)[D.form.icon]?d(A)(d(R)[D.form.icon]):d(A)("scenes/Scenes_icon0.webp")},null,8,Q),n("span",X,c(e.$t("edit")),1)]),r(o,{prop:"name","label-width":"0px"},{default:i((()=>[r(t,{modelValue:D.form.name,"onUpdate:modelValue":a[1]||(a[1]=e=>D.form.name=e),size:d(N),maxlength:"63",placeholder:e.$t("Please enter scene name")},null,8,["modelValue","size","placeholder"])])),_:1})]),D.showUrl?(l(),u(o,{key:0,label:e.$t("Receiver address"),prop:"url"},{default:i((()=>[r(t,{modelValue:D.form.url,"onUpdate:modelValue":a[2]||(a[2]=e=>D.form.url=e),maxlength:"63",placeholder:e.$t("Please enter"),size:d(N)},null,8,["modelValue","placeholder","size"])])),_:1},8,["label"])):m("",!0),r(o,{label:e.$t("Please select the area associated with the scene"),prop:"area"},{default:i((()=>[r(g,{modelValue:D.form.area,"onUpdate:modelValue":a[3]||(a[3]=e=>D.form.area=e),"popper-class":"dia-scene-space-cascader",options:D.newRoomList,props:L,size:d(N),"collasp-tags":"","collasp-tags-tooltip":"",onChange:T},null,8,["modelValue","options","size"])])),_:1},8,["label"]),r(o,{label:e.$t("Whether the scene has status"),prop:"with_state"},{default:i((()=>[r(v,{modelValue:D.form.with_state,"onUpdate:modelValue":a[4]||(a[4]=e=>D.form.with_state=e),label:"",size:d(N)},null,8,["modelValue","size"])])),_:1},8,["label"]),r(o,{label:e.$t("Scene ID"),prop:"scene_id_ext"},{default:i((()=>[r(t,{modelValue:D.form.scene_id_ext,"onUpdate:modelValue":a[5]||(a[5]=e=>D.form.scene_id_ext=e),size:d(N),maxlength:"5",placeholder:e.$t("Please enter scene id")},null,8,["modelValue","size","placeholder"])])),_:1},8,["label"])])),_:1},8,["model","rules","size"])])])),_:1},8,["show","title","button-ok-name"])]),D.imgShow?(l(),u(M,{key:0,show:D.imgShow,"onUpdate:show":a[7]||(a[7]=e=>D.imgShow=e),type:D.form.icon,"onUpdate:type":a[8]||(a[8]=e=>D.form.icon=e)},null,8,["show","type"])):m("",!0)],64)}}},ee={class:"engy-scene-management"},ae={class:"icon-name"},te=["src"],oe=["onClick"],le={class:"engy-device-error-title"},se={__name:"index",setup(t){let o=B();const{t:u}=U(),m=e({tableData:[],handleSelection:[],exportDisable:!1,deleteShow:!1,upLoading:!1,errorShow:!1}),p={1:u("Input cannot be empty."),2:u("Special characters are not allowed."),3:u("Device ID is duplicated."),4:u("Room name does not exist"),5:u("Invalid data.")},f=a(null),w=a(null),b=a(null);g((()=>{I(),T.on("$mitt_api_add_scene",I)})),v((()=>{T.off("$mitt_api_add_scene")}));const _=()=>{setTimeout((()=>{I()}),200)},I=()=>{W.getScenesList((e=>{m.tableData=e.result,w.value.init(e.result)}))},j=()=>{m.errorShow=!1},V=(e,a)=>{const t=e.name.endsWith(".csv");if(!t)return C(u("Please upload the correct file format"),"error"),a(t);a(!0)},E=e=>{m.fileObj=e,m.secondShow=!0},z=()=>{O();const e=new FileReader;e.onload=e=>{const a=e.target.result.split(",")[1];m.upLoading=!0,setTimeout((()=>{m.upLoading=!1}),12e4),W.importSceneList((e=>{var a;if(m.upLoading=!1,b.value.changeShow(),null==e?void 0:e.success)C(u("Success"),"success");else{if(e.result&&e.result.length&&6===(null==(a=e.result[0])?void 0:a.code))return C(u("Please import a template in the correct format"),"error");m.errorData=e.result,m.errorShow=!0}}),a)},e.readAsDataURL(m.fileObj)},O=()=>{m.secondShow=!1},M=()=>{m.deleteShow=!1},G=e=>{m.handleSelection=e},J=e=>{var a;const t=m.tableData.map((e=>e.scene_id)),l=o.scenesList.filter((e=>!t.includes(e.scene_id))).length+(null==(a=m.tableData)?void 0:a.length);if(!e&&Number(l)>=100)return C("最多只能导入100个场景","error");f.value.init(m.tableData,e)},K=()=>{b.value.changeShow()},Q=()=>{m.exportDisable=!0,k({message:u("loading..."),appendTo:"hidden-8850",duration:6e4});W.exportSceneList((()=>{m.exportDisable=!1,k.closeAll()}))},X=()=>{m.deleteShow=!0},se=()=>{const e=[];m.handleSelection.forEach((a=>{e.push(a.scene_id)})),W.deleteScenes(e,(e=>{if(!(null==e?void 0:e.success))return C(u("errorMessage"),"error");M(),setTimeout((()=>{I()}),200)}))};return(e,a)=>{var t;const o=D,u=$,g=L;return l(),s(h,null,[S((l(),s("div",ee,[r(q,{ref_key:"tableIndexRef",ref:w,"delete-disable":!(null==(t=m.handleSelection)?void 0:t.length),"export-disable":m.exportDisable,onOpenAdd:J,onImportFile:K,onExportFile:Q,onHandleDelete:X},{table:i((()=>[r(u,{data:m.tableData,"header-cell-style":d(H),"cell-style":d(Y),style:y({height:"calc(100vh - 197px)",borderRadius:"12px"}),"highlight-current-row":"","scrollbar-always-on":"",size:d(N),onSelectionChange:G},{default:i((()=>[r(o,{type:"selection",width:"100"}),r(o,{"show-overflow-tooltip":"",label:e.$t("Scene Name")},{default:i((e=>[n("div",ae,[n("img",{class:"img-scene",alt:"smart home,home automation,homekit,smart security,smart home systems,google home",src:d(R)[e.row.icon]?d(A)(d(R)[e.row.icon]):d(A)("scenes/Scenes_icon0.webp")},null,8,te),x(" "+c(e.row.name),1)])])),_:1},8,["label"]),r(o,{"show-overflow-tooltip":"",label:e.$t("Whether Status")},{default:i((a=>[x(c(a.row.with_state?e.$t("YES"):e.$t("NO")),1)])),_:1},8,["label"]),r(o,{"show-overflow-tooltip":"",label:e.$t("Scene ID")},{default:i((e=>[x(c(e.row.scene_id_ext),1)])),_:1},8,["label"]),r(o,{"show-overflow-tooltip":"",label:e.$t("edit"),width:"150"},{default:i((e=>[n("div",{class:"device__name__svg",onClick:a=>J(e.row)},null,8,oe)])),_:1},8,["label"])])),_:1},8,["data","header-cell-style","cell-style","style","size"])])),_:1},8,["delete-disable","export-disable"])])),[[g,m.upLoading,void 0,{fullscreen:!0,lock:!0}]]),r(Z,{ref_key:"dialogAddRef",ref:f,onUpdateList:_},null,512),r(P,{show:m.deleteShow,"onUpdate:show":a[0]||(a[0]=e=>m.deleteShow=e),"button-cancel-show":!0,onButtonCancel:M,onButtonConfirm:se},{content:i((()=>[n("div",null,c(e.$t("Do you want to delete these data?")),1)])),_:1},8,["show"]),r(F,{ref_key:"fileRef",ref:b,accept:".csv",title:e.$t("Import scene template"),"is-top-set":!0,onBeforeUpdate:V,onUpload:E},null,8,["title"]),r(P,{show:m.secondShow,"onUpdate:show":a[1]||(a[1]=e=>m.secondShow=e),"button-cancel-show":!0,onButtonCancel:O,onButtonConfirm:z},{content:i((()=>[n("div",null,c(e.$t("After importing the file, the original data will be overwritten. Are you sure you want to continue importing?")),1)])),_:1},8,["show"]),r(P,{show:m.errorShow,"onUpdate:show":a[2]||(a[2]=e=>m.errorShow=e),title:e.$t("Result"),"button-ok-name":e.$t("Close"),onButtonCancel:j,onButtonConfirm:j},{content:i((()=>[n("div",null,[n("div",le,c(e.$t("Import failed, please modify the content and try again")),1),r(u,{data:m.errorData},{default:i((()=>[r(o,{prop:"line",label:e.$t("Error Line")},null,8,["label"]),r(o,{label:e.$t("Reason for failure")},{default:i((e=>[x(c(p[e.row.code]),1)])),_:1},8,["label"])])),_:1},8,["data"])])])),_:1},8,["show","title","button-ok-name"])],64)}}};export{se as default};
